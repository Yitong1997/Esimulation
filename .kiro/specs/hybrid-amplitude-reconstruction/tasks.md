# 任务清单：混合传播复振幅重建优化

## 概述

本文档列出实现混合传播复振幅重建优化所需的所有任务。任务按需求分组，确保每个需求都有对应的实现任务。

核心方法：使用雅可比矩阵方法（网格变形）计算振幅，基于能量守恒原理。

## 任务列表

### 阶段 1：ElementRaytracer 扩展（需求 1）

#### 任务 1.1：添加输入/输出位置获取方法（支持雅可比矩阵）
- [x] 在 `ElementRaytracer.trace()` 中保存输入光线 `self.input_rays = rays_in`
- [x] 添加 `get_input_positions()` 方法返回 `(x, y)` 元组
- [x] 添加 `get_output_positions()` 方法返回 `(x, y)` 元组
- [x] 添加 RuntimeError 检查和中文 docstring

**对应需求**: 需求 1.2, 1.3

**验收标准**：
- 输入/输出位置正确保存和返回
- 与雅可比矩阵计算兼容

#### 任务 1.2：验证光线位置传递
- [x] 创建测试验证输入/输出光线位置正确保存
- [x] 测试有效光线掩模正确
- [x] 测试 OPD 计算正确

**对应需求**: 需求 1.1, 1.4, 1.5

**验收标准**：
- 测试通过
- 覆盖正常和边界情况

### 阶段 2：复振幅重建器（需求 2）

#### 任务 2.1：创建 RayToWavefrontReconstructor 类
- [x] 在 `src/wavefront_to_rays/` 目录下创建 `reconstructor.py` 文件
- [x] 实现 `RayToWavefrontReconstructor` 类基本结构
- [x] 实现 `__init__()` 方法（grid_size, sampling_mm, wavelength_um）
- [x] 添加完整的中文 docstring

**对应需求**: 需求 2.1

**验收标准**：
- 类可以正确初始化
- 参数验证正确

#### 任务 2.2：实现复振幅计算（雅可比矩阵方法）
- [x] 实现 `_compute_amplitude_phase_jacobian()` 私有方法
- [x] 使用 RBF 插值创建输入→输出坐标映射
- [x] 使用数值微分计算雅可比矩阵
- [x] 基于能量守恒计算振幅：`A = 1 / sqrt(|J|)`
- [x] 归一化振幅
- [x] 使用复振幅公式：`A * exp(-j * 2pi * OPD)`

**对应需求**: 需求 2.2, 2.3, 2.4, 2.7

**验收标准**：
- 雅可比行列式计算正确
- 振幅与能量守恒一致
- 数值稳定（避免除零）
- 无效光线区域振幅为 0



#### 任务 2.3：实现网格重采样
- [x] 实现 `_resample_to_grid_separate()` 私有方法
- [x] 使用 scipy.interpolate.griddata 进行三次插值
- [x] 分别插值振幅和相位，然后组合
- [x] 采样范围外设为 0

**对应需求**: 需求 2.5

**验收标准**：
- 插值结果平滑
- 边界处理正确

#### 任务 2.4：实现 reconstruct() 公共方法
- [x] 实现 `reconstruct()` 方法
- [x] 调用 `_compute_amplitude_phase_jacobian()` 和 `_resample_to_grid_separate()`
- [x] 返回复振幅网格

**对应需求**: 需求 2.1

**验收标准**：
- 方法返回正确形状的复数数组
- 接口清晰易用

### 阶段 3：理论曲率相位（需求 3）

#### 任务 3.1：实现理论曲率相位计算
- [x] 在 `SequentialOpticalSystem` 中添加 `_compute_theory_curvature_phase()` 方法
- [x] 实现公式：`phi = -k * r^2 / (2f)`
- [x] 处理平面镜（f = inf）返回零相位
- [x] 确保不包含倾斜分量

**对应需求**: 需求 3.1, 3.2, 3.3, 3.4

**验收标准**：
- 平面镜返回零相位
- 聚焦元件返回正确的二次相位
- 相位单位为弧度

### 阶段 4：PROPER 波前更新（需求 4）

#### 任务 4.1：实现波前更新逻辑
- [x] 修改 `_apply_element_hybrid()` 中的波前更新部分
- [x] 使用 `proper.prop_shift_center()` 转换坐标系
- [x] 更新 `wfo.wfarr`
- [x] 保持高斯光束参数更新（`_update_gaussian_params_only()`）

**对应需求**: 需求 4.1, 4.2, 4.3, 4.4

**验收标准**：
- 波前正确更新
- FFT 坐标系处理正确
- 接口兼容性保持

### 阶段 5：坐标系统（需求 5）

#### 任务 5.1：验证坐标系统一致性
- [x] 创建测试验证光线坐标与 PROPER 网格坐标对应
- [x] 验证采样范围正确
- [x] 验证插值映射正确

**对应需求**: 需求 5.1, 5.2, 5.3, 5.4

**验收标准**：
- 坐标系统测试通过
- 边界处理正确

### 阶段 6：错误处理（需求 6）

#### 任务 6.1：实现错误处理和相位突变检测
- [x] 有效光线 < 4 时抛出 `InsufficientRaysError` 异常
- [x] 实现 `_check_phase_discontinuity_on_grid()` 方法：
  - [x] 在重采样完成后、加回理想相位之前执行
  - [x] 计算网格上相邻像素（x 和 y 方向）的相位差
  - [x] 只检查有效区域（振幅 > 0）内的相位差
  - [x] 如果最大相位差 > π，发出 UserWarning
  - [x] 警告信息包含：最大相位差（弧度和波长数）、建议（增加采样密度）
- [x] 雅可比行列式接近零时使用最小值限制避免除零
- [x] 添加可选的调试输出参数

**对应需求**: 需求 6.1, 6.2, 6.3, 6.4, 6.5

**验收标准**：
- 错误信息清晰
- 相位检测在正确的时机执行（重采样后、加回理想相位前）
- 边界情况处理正确

### 阶段 7：集成与验证（需求 7）

#### 任务 7.1：重构 _apply_element_hybrid()
- [x] 集成 `RayToWavefrontReconstructor`（注：当前实现使用直接插值方法，RayToWavefrontReconstructor 作为独立模块可用）
- [x] 集成理论曲率相位计算
- [x] 保持现有接口不变
- [x] 添加完整的中文 docstring

**对应需求**: 需求 7.1, 7.2

**验收标准**：
- 方法功能完整
- 接口兼容

#### 任务 7.2：运行现有测试
- [x] 运行所有现有单元测试
- [x] 运行所有现有集成测试
- [x] 修复任何回归问题（注：test_wavefront_quality 测试失败是已存在的问题，非本次更改引入）

**对应需求**: 需求 7.2

**验收标准**：
- 所有现有测试通过

#### 任务 7.3：伽利略 OAP 扩束器验证
- [x] 更新 `tests/test_galilean_oap_integration.py`
- [x] 验证振幅变化符合预期
- [x] 验证光束扩展比
- [x] 验证波前质量

**对应需求**: 需求 7.3

**验收标准**：
- 伽利略 OAP 扩束器测试通过
- 结果与理论预期一致

#### 任务 7.4：雅可比矩阵方法的高斯光束验证
- [x] 创建 `tests/test_jacobian_amplitude_gaussian.py`
- [x] 设计高斯光束测试场景（已知理论解）
- [x] 使用雅可比矩阵方法计算振幅
- [x] 与理论高斯光束分布对比
- [x] 验证能量守恒

**对应需求**: 需求 2.3, 2.4

**验收标准**：
- 雅可比矩阵方法正确处理高斯光束
- 振幅分布与理论预期一致
- 能量守恒误差 < 5%

## 依赖关系

```
任务 1.1 ──┐
任务 1.2 ──┤
           │
任务 2.1 ──┼──▶ 任务 2.2 ──▶ 任务 2.3 ──▶ 任务 2.4 ──┐
           │                                         │
任务 3.1 ──┼─────────────────────────────────────────┤
           │                                         │
任务 4.1 ──┼─────────────────────────────────────────┼──▶ 任务 7.1 ──▶ 任务 7.2 ──┬──▶ 任务 7.3
           │                                         │                            │
任务 5.1 ──┼─────────────────────────────────────────┤                            └──▶ 任务 7.4
           │                                         │
任务 6.1 ──┴─────────────────────────────────────────┘
```

## 优先级

1. **高优先级**：任务 1.1, 2.1-2.4, 3.1, 4.1, 7.1（核心功能）
2. **中优先级**：任务 1.2, 5.1, 6.1, 7.2（测试和错误处理）
3. **低优先级**：任务 7.3, 7.4（验证）

## 估计工时

| 阶段 | 任务数 | 估计工时 |
|------|--------|----------|
| 阶段 1 | 2 | 2 小时 |
| 阶段 2 | 4 | 5 小时 |
| 阶段 3 | 1 | 1 小时 |
| 阶段 4 | 1 | 1 小时 |
| 阶段 5 | 1 | 1 小时 |
| 阶段 6 | 1 | 1.5 小时 |
| 阶段 7 | 4 | 4 小时 |
| **总计** | **14** | **15.5 小时** |

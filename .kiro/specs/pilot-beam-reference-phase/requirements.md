# 需求文档：Pilot Beam 参考相位（简化版）

## 概述

改进 Pilot Beam 参考相位计算方法，使用 ABCD 矩阵法追踪光束参数，无需从波前拟合估计。

## 背景

当前实现的问题：
1. Pilot Beam 参数（beam_waist）使用简单估计 `physical_size / 4`，与实际光束不匹配
2. 参考相位计算发生在切平面，但没有正确考虑镜面反射后的光束参数变化
3. 相位梯度过大导致采样检查失败

## 简化方案

**核心思想**：由于初始高斯光束参数已知，使用 ABCD 矩阵法可以精确追踪光束在整个系统中的演变，无需从波前拟合估计参数。

## 用户故事

### US-1: ABCD 矩阵追踪

**作为**光学仿真用户，**我希望**系统能够使用 ABCD 矩阵法追踪高斯光束在整个系统中的演变，**以便**在每个元件处获得精确的光束参数。

#### 验收标准

- 1.1 系统能够从初始高斯光束参数开始追踪
- 1.2 系统能够计算每个元件入射面的光束参数
- 1.3 系统能够计算每个元件出射面的光束参数
- 1.4 支持反射镜（球面镜、抛物面镜、平面镜）
- 1.5 支持透镜（薄透镜）
- 1.6 计算结果应与解析解在数值精度范围内一致（相对误差 < 1%）

### US-2: 参考相位计算

**作为**光学仿真用户，**我希望**系统能够在任意位置计算高斯光束的参考相位，**以便**从光线追迹的 OPD 中提取残差相位。

#### 验收标准

- 2.1 系统能够在指定坐标处计算参考相位
- 2.2 系统能够在网格上计算参考相位
- 2.3 系统能够在光线位置计算参考相位
- 2.4 参考相位应正确反映波前曲率
- 2.5 平面波前（R=∞）时参考相位为零

### US-3: 简化的 PilotBeamCalculator 接口

**作为**光学仿真用户，**我希望**PilotBeamCalculator 能够直接使用高斯光束和元件列表，**以便**无需手动指定 Pilot Beam 参数。

#### 验收标准

- 3.1 PilotBeamCalculator 接受 GaussianBeam 对象
- 3.2 PilotBeamCalculator 接受元件列表
- 3.3 内部自动创建 ABCDCalculator
- 3.4 支持指定元件索引和位置（入射/出射）
- 3.5 保持与现有接口的向后兼容

### US-4: 验证功能

**作为**光学仿真用户，**我希望**系统能够验证 Pilot Beam 方法的适用性，**以便**在参数不匹配时收到警告。

#### 验收标准

- 4.1 验证相位采样是否充足
- 4.2 验证光束发散角是否过大
- 4.3 验证光束尺寸匹配度
- 4.4 在验证失败时发出警告但继续执行

## 非功能性需求

### NFR-1: 性能

- 参考相位计算时间应 < 10ms（512×512 网格）
- ABCD 矩阵计算应 < 1ms

### NFR-2: 兼容性

- 应保持与现有 HybridElementPropagator 接口的向后兼容
- 应复用现有模块，避免代码重复

### NFR-3: 可测试性

- 每个方法应有独立的单元测试
- 应有属性测试验证数学正确性

## 不需要的功能（已删除）

以下功能因简化设计而不再需要：

- BeamEstimator 模块（从波前拟合估计光束参数）
- PROPER 传播方法（方案 2）
- 光束参数拟合质量指标

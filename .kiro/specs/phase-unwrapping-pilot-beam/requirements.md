# 需求文档：基于 Pilot Beam 的相位解包裹

## 概述

解决 PROPER 提取的折叠相位在几何光线追迹中导致的 2nπ 相位误差问题。通过使用 Pilot Beam 参考相位进行解包裹，确保光线采样和出射面重采样时相位的连续性。

## 背景

### 问题描述

当前实现中存在以下问题：

1. **PROPER 返回折叠相位**：`proper.prop_get_phase(wfo)` 返回的相位范围在 [-π, π]，当波前曲率较大时会发生 2π 折叠

2. **光线采样使用折叠相位**：在入射面对光线采样时，直接使用折叠相位构建相位元件

3. **出射面重采样误差**：在出射面进行网格重采样时，光线追迹得到的相位与参考相位比较会出现 2nπ 的差异

4. **OPD 提取错误**：由于相位不连续，提取的 OPD 出现跳变，导致仿真结果不正确

### 解决方案概述

使用 Pilot Beam（基于 ABCD 法则计算的理想高斯光束）作为参考，在入射面对 PROPER 提取的折叠相位进行解包裹：

```
T_unwrapped = T_pilot + angle(exp(1j * (T - T_pilot)))
```

其中：
- `T`: PROPER 提取的折叠相位
- `T_pilot`: Pilot Beam 计算的非折叠参考相位
- `angle()`: 将复数映射到 （-π, π] 的相位

## 用户故事

### US-1: 入射面相位解包裹

**作为**光学仿真用户，**我希望**系统能够在入射面对 PROPER 提取的折叠相位进行解包裹，**以便**光线采样时使用连续的相位分布。

#### 验收标准

- 1.1 系统能够从 PROPER 波前提取折叠相位
- 1.2 系统能够计算 Pilot Beam 在入射面的参考相位
- 1.3 系统能够使用公式 `T_pilot + angle(T - T_pilot)` 进行解包裹
- 1.4 解包裹后的相位应与 Pilot Beam 相位差异小于 π
- 1.5 解包裹后的相位应平滑连续，无 2π 跳变

### US-2: 出射面相位一致性

**作为**光学仿真用户，**我希望**在出射面进行网格重采样时，光线追迹的相位与参考相位保持一致，**以便**正确提取 OPD。

#### 验收标准

- 2.1 光线追迹得到的相位应是非折叠的（因为入射面已解包裹）
- 2.2 出射面的 Pilot Beam 参考相位应是非折叠的
- 2.3 光线相位与参考相位的差值（OPD）应平滑连续
- 2.4 OPD 中不应出现 2π 跳变

### US-3: Pilot Beam 参考相位计算

**作为**光学仿真用户，**我希望**系统能够在任意入射面和出射面计算 Pilot Beam 的非折叠参考相位，**以便**用于相位解包裹和 OPD 提取。

#### 验收标准

- 3.1 系统能够使用 ABCD 法则追踪高斯光束参数
- 3.2 系统能够在入射面计算 Pilot Beam 相位
- 3.3 系统能够在出射面计算 Pilot Beam 相位
- 3.4 Pilot Beam 相位应以非折叠方式解析计算
- 3.5 Pilot Beam 相位定义为相对于主光线的相位延迟（主光线处为 0）

### US-4: 验证与诊断

**作为**光学仿真用户，**我希望**系统能够验证相位解包裹的正确性，**以便**在出现问题时进行诊断。

#### 验收标准

- 4.1 系统能够检测入射面解包裹后的相位连续性
- 4.2 系统能够检测出射面 OPD 的连续性
- 4.3 系统能够报告相位跳变的位置和大小
- 4.4 系统能够可视化解包裹前后的相位分布

## 非功能性需求

### NFR-1: 性能

- 相位解包裹计算时间应 < 10ms（512×512 网格）
- 不应显著增加整体仿真时间

### NFR-2: 数值精度

- 解包裹后的相位误差应 < 0.01 rad
- OPD 提取误差应 < λ/100

### NFR-3: 兼容性

- 应与现有 HybridElementPropagator 接口兼容
- 应与现有 PilotBeamCalculator 集成

### NFR-4: 可测试性

- 每个步骤应有独立的单元测试
- 应有端到端的集成测试验证完整流程

## 依赖关系

本 spec 依赖于以下已完成的工作：

- `pilot-beam-reference-phase` spec：提供 ABCD 矩阵追踪和 Pilot Beam 参考相位计算
- `hybrid-element-propagation` spec：提供混合传播框架

## 测试场景

### 场景 1: 简单球面波前

- 输入：具有已知曲率的球面波前
- 验证：解包裹后相位与理论值一致

### 场景 2: 大曲率波前（多次折叠）

- 输入：曲率足够大导致多次 2π 折叠的波前
- 验证：解包裹后相位连续，无跳变

### 场景 3: 带像差的波前

- 输入：具有像差的波前（如球差、彗差）
- 验证：解包裹后保留像差信息，OPD 正确提取

### 场景 4: 多元件系统

- 输入：包含多个光学元件的系统
- 验证：每个元件的入射面和出射面相位处理正确

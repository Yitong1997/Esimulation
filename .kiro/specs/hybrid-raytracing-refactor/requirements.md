# 混合光线追迹重构需求文档

## 背景

当前 `ElementRaytracer` 在处理倾斜反射镜（如45°折叠镜）时存在问题：
1. 使用 optiland 的 `surface_group.trace()` 进行光线追迹
2. 反射后光线方向变为非 Z 轴方向（如 `(0, -1, 0)`）
3. optiland 使用 `t = thickness / N` 计算传播距离
4. 当 `N=0` 时，`t=inf`，导致光线位置变为 NaN

## 解决方案

**核心思路**：在 optiland 光学系统中添加一个**倾斜的透明平面**作为出射面，让 optiland 自动完成光线传播和 OPD 计算。

**关键发现**：
1. optiland 的 `add_surface()` 支持 `rx`, `ry` 参数，可以添加任意倾斜的表面
2. 设置 `material='air'` 可以创建透明平面，光线直接穿过
3. optiland 会自动计算光线与倾斜平面的交点，并正确更新 OPD

## 需求列表

### REQ-1: 计算出射主光线方向

#### REQ-1.1: 使用反射定律计算
- 对于反射镜：使用反射公式 `r = d - 2(d·n)n`
- 考虑表面倾斜对法向量的影响
- 返回归一化的方向余弦

#### REQ-1.2: 方向到旋转角度转换
- 将出射主光线方向 (L, M, N) 转换为旋转角度 (rx, ry)
- 旋转顺序为 X → Y
- 初始方向为 (0, 0, 1)

### REQ-2: 添加倾斜的透明出射面

#### REQ-2.1: 在 optiland 中添加出射面
- 在元件表面后添加一个平面（radius=inf）
- 设置 `material='air'`，光线直接穿过
- 设置正确的旋转角度 `rx`, `ry`

#### REQ-2.2: 出射面位置
- 出射面位置在元件顶点处（thickness=0）
- 出射面垂直于出射主光线方向

### REQ-3: 简化的光线追迹

#### REQ-3.1: 直接使用 optiland 追迹
- 调用 `surface_group.trace()` 完成整个追迹
- optiland 自动处理：
  - 光线与元件表面的交点
  - 反射/折射方向计算
  - 光线与出射面的交点
  - OPD 累加

#### REQ-3.2: 坐标变换
- 入射光线从入射面局部坐标系转换到全局坐标系
- 出射光线从全局坐标系转换到出射面局部坐标系
- 出射光线在出射面局部坐标系中 z=0

### REQ-4: OPD 计算

#### REQ-4.1: 由 optiland 自动计算
- optiland 会自动累加光程到 OPD
- 包含入射段（入射面到表面）和出射段（表面到出射面）

#### REQ-4.2: 相对于主光线计算
- OPD = 光线光程 - 主光线光程
- 单位为波长数
- 主光线为光瞳中心的光线

## 验收标准

### AC-1: 45° 折叠镜测试
- 输入平面波，经 45° 折叠镜反射
- 输出应仍为平面波
- 光束半径不变
- WFE RMS < 0.01 波长

### AC-2: 伽利略式 OAP 扩束镜测试
- 输入 10mm 束腰高斯光束
- 经 OAP1（凸面）、折叠镜、OAP2（凹面）
- 输出 30mm 束腰高斯光束（3x 扩束）
- 各采样面光束半径误差 < 5%
- WFE RMS < 0.1 波长

### AC-3: 出射面位置正确性
- 出射光线在出射面局部坐标系中 z ≈ 0
- 主光线的出射面交点在元件顶点

## 约束条件

### 技术约束
- 完全复用 optiland 的光线追迹能力
- 不手动实现光线传播逻辑
- 保持与现有 API 的兼容性

### 性能约束
- 光线追迹性能不应显著下降
- 支持大量光线（>10000）的追迹

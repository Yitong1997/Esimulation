<!------------------------------------------------------------------------------------
# 测试规范

inclusion: fileMatch
fileMatchPattern: '**/tests/**,**/*test*,**/*spec*'
------------------------------------------------------------------------------------>

## 主程序编写风格

**采用 MATLAB 风格的"代码块"结构，而非 Python 类封装风格。**

主程序应包含清晰分隔的代码块：
1. 导入与初始化
2. 定义光学系统（ZMX 导入或逐行定义）
3. 定义光源
4. 系统信息展示
5. 执行仿真
6. 结果展示与保存

**核心原则**：
- 代码块分明，一目了然
- API 简洁，复杂逻辑封装在模块内部
- 传参稳定，不频繁变动

---

## 测试框架

- **pytest**：单元测试和集成测试
- **hypothesis**：属性基测试
- **numpy.testing**：数值比较

## 目录结构

```
tests/
├── unit/           # 单元测试
├── integration/    # 集成测试
├── validation/     # 验证测试
├── property/       # 属性基测试
└── conftest.py     # pytest 配置
```

## 命名约定

- 测试文件：`test_<模块名>.py`
- 测试类：`Test<类名>`
- 测试方法：`test_<功能描述>`

---

## 调试规范

### ⚠️ 核心原则

**优先在同一个端到端文件内进行编辑与测试，复用现有模块，尽量不要新建测试文件。**

### 何时可以新建文件

- 需要生成可视化图表或报告
- 作为 `examples/` 目录下的长期示例

### 精度问题调试方法论

**逐步定位，由粗到细：**

1. **定位问题发生的位置**：确定在哪个面或自由空间传输中
2. **定位问题发生的阶段**：入射面处理、光线追迹、还是出射面处理
3. **逐步深入调试**：专注于已定位的局部代码，每次只修改一处

**禁止**：在未定位问题根源的情况下，盲目修改多处代码。

---

## 测试覆盖率目标

- 整体覆盖率 > 80%
- 核心模块覆盖率 > 90%
- 所有公共 API 100% 覆盖

<!------------------------------------------------------------------------------------
# 混合光学仿真项目 - 核心规范

项目核心：PROPER（物理光学传输）+ optiland（几何光线追迹 OPD 计算）
inclusion: always
------------------------------------------------------------------------------------>

## 库的调用方式

- `import proper` — 物理光学传输
- `from optiland.optic import Optic` — 几何光线追迹（注意：从子模块导入）

工作区内的 `optiland-master/` 和 `proper_v3.3.4_python/` 仅作为 API 文档参考。

---

## 坐标系统

### 全局坐标系（右手系）

Z 轴为初始光轴方向，Y 轴垂直向上，X 轴由右手定则确定。

### 光轴是动态的

- 反射元件会改变光轴方向
- 所有面的倾斜都相对于**当前光轴**定义
- 系统自动追踪主光线方向变化

---

## PROPER 复振幅存储方式

### ⚠️ 关键：附加参考波前

- `wfarr` 存储相对于参考球面的偏差，不是绝对相位
- `prop_lens` 更新参考球面参数，不直接修改 `wfarr` 中的相位
- 理想聚焦效果由参考球面跟踪，`wfarr` 中只包含像差

### ⚠️ 关键：PROPER 提取的相位是折叠相位

- `prop_get_phase(wfo)` 返回折叠相位，范围 [-π, π]
- 必须在光线采样前进行相位解包裹

### 采样面始终垂直于光轴

- 波前不具有整体倾斜，无论光路是否折叠
- **不要向 PROPER 波前添加整体倾斜相位**

---

## 入射面与出射面

**入射面和出射面永远垂直于光轴，与 `is_fold` 参数无关。**

---

## 倾斜处理

### ⚠️ 强制规定：is_fold 必须始终为 False

`is_fold=True` 已被废弃，不应使用。

### is_fold=False 时的倾斜补偿

- 系统追踪主光轴方向变化
- 入射面垂直于入射光轴，出射面垂直于出射光轴
- OPD 相对于主光线计算，倾斜相位被自动补偿
- **结果中不包含整体倾斜，只包含真实像差**

---

## 符号约定

- **曲率半径**：正值 = 曲率中心在 +Z 方向
- **厚度**：正值 = 沿 +Z 方向
- **旋转角度**：正值 = 右手定则

---

## 单位约定

| 项目 | optiland | PROPER |
|------|----------|--------|
| 长度 | mm | m |
| OPD/相位 | 波长数 | 弧度 |

转换：`phase = 2π × opd_waves`

---

## 数据流

```
输入光源 → [PROPER: 初始波前] → [optiland: 元件OPD] → [PROPER: 传输] → ... → 输出
```

---

## ⚠️ 传播距离计算

### 核心原则：使用主光线交点距离

**自由空间传播距离必须用主光线在相邻面上的交点距离计算，而不是面的厚度参数。**

### 计算方法

1. 事先追迹主光线穿过整个系统
2. 记录主光线与每个面的交点坐标
3. 传播距离 = 两个交点之间的欧氏距离

### 原因

在离轴系统、倾斜元件等情况下，厚度参数与主光线实际传播距离不相等。

---

## Pilot Beam 与相位解包裹

### Pilot Beam 参考波前

基于 ABCD 法则在每个入射面和出射面处计算理想波前形状。

特性：
- 波前相位以非折叠方式解析计算
- 相位定义为相对于主光线的相位延迟
- 主光线处相位为 0

### ⚠️ 关键：入射面相位解包裹

**在几何光线追迹中，对入射面采样光线之前，必须对 PROPER 提取的折叠相位进行解包裹。**

解包裹公式：`T_unwrapped = T_pilot + angle(exp(1j × (T - T_pilot)))`

### 数据流

```
问题场景（不解包裹）：
┌─────────────────────────────────────────────────────────────┐
│ 入射面：PROPER 相位有 2π 跳变                                │
│ → 光线携带折叠相位                                           │
│ → 出射面出现 2nπ 误差                                        │
└─────────────────────────────────────────────────────────────┘

正确流程（解包裹）：
┌─────────────────────────────────────────────────────────────┐
│ 入射面：用 Pilot Beam 解包裹 → 相位连续                      │
│ → 光线携带非折叠相位                                         │
│ → 出射面 OPD 正确提取                                        │
└─────────────────────────────────────────────────────────────┘
```

### 实现要点

1. **入射面**：解包裹后相位应与 Pilot Beam 相位差异小于 π
2. **出射面**：重采样后的 OPD 应平滑连续，无 2π 跳变

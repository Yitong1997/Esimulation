<!------------------------------------------------------------------------------------
# 混合光学仿真项目 - 核心规范

项目核心：PROPER（物理光学传输）+ optiland（几何光线追迹 OPD 计算）
inclusion: always
------------------------------------------------------------------------------------>

## 库的调用方式

```python
import proper                        # 物理光学传输
from optiland.optic import Optic     # 几何光线追迹（注意：从子模块导入）
```

工作区内的 `optiland-master/` 和 `proper_v3.3.4_python/` 仅作为 API 文档参考。

---

## 坐标系统

### 全局坐标系（右手系）

```
        Y (向上)
        |
        |________ Z (光轴方向)
       /
      X
```

### 光轴是动态的

- 反射元件会改变光轴方向
- 所有面的倾斜都相对于**当前光轴**定义
- 系统自动追踪主光线方向变化

---

## PROPER 复振幅存储方式

### ⚠️ 关键：附加参考波前

**PROPER 的复振幅是相对于参考球面波前存储的，而不是绝对相位。**

- `wfarr` 中存储的相位是相对于参考球面的偏差
- `prop_lens` 更新参考球面参数，而不是直接修改 `wfarr` 中的相位
- 理想聚焦效果由参考球面跟踪，`wfarr` 中只包含像差

### ⚠️ 关键：PROPER 提取的相位是折叠相位

**`proper.prop_get_phase(wfo)` 返回的是折叠（wrapped）相位，范围在 [-π, π]。**

- 当波前曲率较大时，相位会发生 2π 折叠
- 直接使用折叠相位进行光线采样会导致出射面重采样时出现 2nπ 的相位误差
- 必须在光线采样前进行相位解包裹

### 采样面始终垂直于光轴

- PROPER 记录的复振幅在垂直于光轴的平面上采样
- 波前不具有整体倾斜（Tilt），无论光路是否折叠
- **不要向 PROPER 波前添加整体倾斜相位**

---

## 入射面与出射面

### ⚠️ 核心定义：永远垂直于光轴

**入射面和出射面永远垂直于光轴，与 `is_fold` 参数无关。**

```
入射面（⊥入射光轴）    元件      出射面（⊥出射光轴）
        |               /              |
        |              /               |
   PROPER 波前  →  光线追迹  →   PROPER 波前
   （无倾斜）      计算 OPD      （无倾斜）
```

---

## 倾斜处理与 is_fold 参数

### ⚠️ 关键：倾斜不导致出入射面有倾斜量

**`is_fold` 只影响元件处的复振幅计算方式，不影响入射面和出射面相对于光轴的角度。**

### is_fold=False（默认）时的倾斜补偿

当 `is_fold=False` 时，虽然元件带有倾斜量，但结果中不会包含波前倾斜：

1. 系统追踪主光轴方向变化
2. 入射面垂直于入射光轴，出射面垂直于出射光轴
3. OPD 相对于主光线计算
4. 倾斜相位被自动补偿

```
is_fold=False 时的倾斜补偿：

入射光轴 →              入射面（⊥入射光轴）
    |                        |
   / ← 45°倾斜元件           | ← OPD 相对于主光线（倾斜被补偿）
  /                          |
 ↓                           ↓
出射光轴              出射面（⊥出射光轴）

结果：OPD 中不包含整体倾斜，只包含真实像差
```

### is_fold 参数对比

| 特性 | is_fold=False（默认） | is_fold=True |
|------|----------------------|--------------|
| 元件处计算 | 带倾斜的光线追迹 | 不带倾斜的简化计算 |
| 倾斜相位 | 自动补偿 | 不计算 |
| 波前倾斜 | 无 | 无 |

**总结**：无论元件倾斜角度多大，结果中都不应当具有倾斜量，只包含真实像差。

---

## 符号约定

- **曲率半径**：正值 = 曲率中心在 +Z 方向
- **厚度**：正值 = 沿 +Z 方向
- **旋转角度**：正值 = 右手定则

---

## 单位约定

| 项目 | optiland | PROPER |
|------|----------|--------|
| 长度 | mm | m |
| OPD/相位 | 波长数 | 弧度 |

转换：`phase = 2π × opd_waves`

---

## 数据流

```
输入光源 → [PROPER: 初始波前] → [optiland: 元件OPD] → [PROPER: 传输] → ... → 输出
```

---

## Pilot Beam 与相位解包裹

### ⚠️ 核心机制：Pilot Beam 参考波前

**在整个传播过程中，基于 ABCD 法则在每个入射面和出射面处计算理想波前形状（Pilot Beam）。**

Pilot Beam 的特性：
- 波前相位以**非折叠方式**解析计算
- 相位定义为相对于主光线的相位延迟
- 主光线处相位为 0
- 提供连续、平滑的参考相位分布

### ABCD 法则计算 Pilot Beam

```python
# Pilot Beam 参数通过 ABCD 矩阵传播
# 输入：初始束腰位置 z0、束腰半径 w0、波长 λ
# 输出：任意位置的曲率半径 R(z) 和光斑大小 w(z)

# 复参数 q 的传播
q_out = (A * q_in + B) / (C * q_in + D)

# 从 q 提取曲率半径
R = 1 / Re(1/q)

# Pilot Beam 相位（非折叠，解析计算）
# 相对于主光线，在半径 r 处的相位延迟
phi_pilot(r) = k * r² / (2 * R)  # k = 2π/λ
```

### ⚠️ 关键：入射面相位解包裹

**在几何光线追迹中，对入射面采样光线之前，必须对 PROPER 提取的折叠相位进行解包裹。**

#### 解包裹公式

```python
# T: PROPER 提取的折叠相位（范围 [-π, π]）
# T_pilot: Pilot Beam 计算的非折叠参考相位
# T_unwrapped: 解包裹后的相位

T_unwrapped = T_pilot + angle(exp(1j * (T - T_pilot)))

# 等价于：
T_unwrapped = T_pilot + np.angle(np.exp(1j * (T - T_pilot)))
```

其中 `angle()` 函数将括号内的值映射到 [-π, π] 范围。

#### 为什么需要解包裹

```
问题场景（不解包裹）：
┌─────────────────────────────────────────────────────────────┐
│ 入射面                                                       │
│   PROPER 相位 T（折叠）: ... 3.0, 3.1, -3.1, -3.0 ...       │
│                              ↑ 2π 跳变                       │
│   用于光线采样 → 光线携带折叠相位                            │
│                                                              │
│ 出射面                                                       │
│   光线追迹相位（折叠）与参考相位比较                         │
│   → 出现 2nπ 的误差                                          │
│   → OPD 提取错误                                             │
└─────────────────────────────────────────────────────────────┘

正确流程（解包裹）：
┌─────────────────────────────────────────────────────────────┐
│ 入射面                                                       │
│   PROPER 相位 T（折叠）: ... 3.0, 3.1, -3.1, -3.0 ...       │
│   Pilot Beam 相位 T_pilot（非折叠）: ... 3.0, 3.1, 3.2, 3.3 │
│   解包裹: T_unwrapped = T_pilot + angle(T - T_pilot)         │
│   结果: ... 3.0, 3.1, 3.2, 3.3 ... （连续）                  │
│   用于光线采样 → 光线携带非折叠相位                          │
│                                                              │
│ 出射面                                                       │
│   光线追迹相位（非折叠）与参考相位比较                       │
│   → 相位差平滑连续                                           │
│   → OPD 正确提取                                             │
└─────────────────────────────────────────────────────────────┘
```

### 实现要点

1. **入射面处理**：
   - 计算 Pilot Beam 在入射面的相位分布 `T_pilot_in`
   - 从 PROPER 提取折叠相位 `T_in`
   - 解包裹：`T_unwrapped_in = T_pilot_in + angle(T_in - T_pilot_in)`
   - 使用 `T_unwrapped_in` 构建相位元件进行光线采样

2. **出射面处理**：
   - 计算 Pilot Beam 在出射面的相位分布 `T_pilot_out`
   - 光线追迹得到的相位已经是非折叠的
   - 可以直接与 `T_pilot_out` 比较提取 OPD
   - OPD 平滑连续，可正确进行网格重采样

3. **验证检查**：
   - 入射面：解包裹后相位应与 Pilot Beam 相位差异小于 π
   - 出射面：重采样后的 OPD 应平滑连续，无 2π 跳变

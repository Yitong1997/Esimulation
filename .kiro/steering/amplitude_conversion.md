<!------------------------------------------------------------------------------------
# 复振幅表示与换算规范

本文件定义了混合光学仿真系统中复振幅表示的关系和数据流。

inclusion: always
------------------------------------------------------------------------------------>

## 概述

混合光学仿真系统使用两种复振幅表示：

| 表示方式 | 存储内容 | 适用场景 |
|----------|----------|----------|
| **仿真复振幅** | 绝对相位（非折叠） | 系统内部统一表示 |
| **PROPER 复振幅** | 复振幅经参考波面处理后的结果 | 自由空间衍射传播 |

---

## 仿真复振幅

系统内部使用的统一复振幅表示，存储绝对相位（非折叠）。

**特点**：
- 相位是连续的，无 2π 跳变
- 主光线处相位定义为 0
- 可直接用于几何光线追迹的相位采样

---

## PROPER 复振幅

**⚠️ 核心原则**：
- PROPER 的 `wfarr` 存储的是**复振幅经参考波面处理后的结果**
- 高斯光束参数（w0, z_w0, z_Rayleigh）**只用于选择传播算法**
- 所有 wfo 属性必须根据 pilot beam 参数正确设置

**参考面类型**：

| reference_surface | 条件 | 处理方式 |
|-------------------|------|----------|
| PLANAR | 近场（`|z - z_w0| < z_R`） | 无参考波面处理 |
| SPHERI | 远场（`|z - z_w0| ≥ z_R`） | 减去参考球面相位 |

**SPHERI 参考面的关系**：
- 参考球面曲率半径：`R_ref = z - z_w0`（PROPER 远场近似）
- 参考球面相位：`φ_ref = k × r² / (2 × R_ref)`（正号）
- wfarr = 仿真复振幅 × exp(-i × φ_ref)


---

## Pilot Beam 参考相位

用于几何光线追迹时的相位解包裹。

**相位公式**（相对于主光线的相位延迟）：
- `φ_pilot(r) = k × r² / (2 × R)`
- 曲率半径使用**严格公式**：`R = z × (1 + (z_R/z)²)`

**为什么不包含 Gouy 相位**：
- Gouy 相位是空间常数（同一 z 平面上所有点相同）
- Pilot Beam 相位定义为相对于主光线的相位延迟
- 主光线处和边缘处的 Gouy 相位相同，计算相对相位时被抵消

---

## ⚠️ 关键区别：PROPER 参考面 vs Pilot Beam

| 项目 | PROPER 参考面 | Pilot Beam |
|------|---------------|------------|
| **曲率半径公式** | `R_ref = z - z_w0`（远场近似） | `R = z × (1 + (z_R/z)²)`（严格精确） |
| **适用范围** | 仅远场（z >> z_R） | 任意距离 |
| **用途** | PROPER 内部参考面计算 | 几何光线追迹相位解包裹 |

**⚠️ 禁止混用**：两种曲率半径公式绝对不能混用。

---

## 数据流

### 写入 PROPER

```
仿真复振幅
    ↓
判断参考面类型（根据 z 与 z_R 的关系）
    ↓
┌─ PLANAR：直接写入
└─ SPHERI：减去参考球面相位后写入
    ↓
使用 prop_shift_center 移到 FFT 坐标系
    ↓
写入 wfo.wfarr
```

### 从 PROPER 读取

```
wfo.wfarr
    ↓
prop_get_amplitude / prop_get_phase（自动移回中心）
    ↓
┌─ PLANAR：直接使用
└─ SPHERI：加回参考球面相位
    ↓
得到完整相位（包裹的）
    ↓
使用 Pilot Beam 解包裹
    ↓
仿真复振幅
```

### 几何光线追迹

```
入射面：
仿真复振幅 → 使用 Pilot Beam 解包裹 → 光线采样

出射面：
出射光线相位 - Pilot Beam 相位 = 残差 OPD
    ↓
残差 OPD 重采样到网格
    ↓
加回 Pilot Beam 相位 → 仿真复振幅
```

---

## 单位约定

| 量 | PROPER 内部 | 仿真系统 |
|----|-------------|----------|
| 长度 | m | mm |
| 波长 | m | μm |
| 相位 | rad | rad |

---

## ⚠️ 关键注意事项

1. **wfarr 存储经参考波面处理后的复振幅**
2. **高斯光束参数只用于选择传播算法**，不影响存储内容
3. **prop_shift_center**：写入 wfarr 时必须使用
4. **参考球面相位符号**：正号 `+k*r²/(2*R_ref)`
5. **SPHERI 参考面**：写入时减去，读取时加回
6. **相位解包裹**：读取的相位是包裹相位，需要用 Pilot Beam 解包裹
7. **采样变化**：远场传播后采样会变化
8. **振幅缩放**：远场传播后振幅有缩放因子
9. **beam_diameter/2 = w0**：初始化时 beam_diameter 是束腰直径

---

## 验证结果

### StateConverter 写入/读取精度

经过验证，StateConverter 的写入/读取是**完美可逆的**：

| 测试条件 | 参考面类型 | 相位误差 RMS |
|----------|------------|--------------|
| z = 0 (近场) | PLANAR | 0.000000 waves |
| z = 1×z_R | SPHERI | 0.000000 waves |
| z = 3×z_R | SPHERI | 0.000000 waves |
| z = 10×z_R | SPHERI | 0.000000 waves |

### PROPER 自由空间传播精度

PROPER 传播后，入射面相位与 Pilot Beam 的比较：

| 表面 | 误差 RMS | 结论 |
|------|----------|------|
| Surface 2 入射面 | 0.0001 milli-waves | **极其精确** |
| Surface 3 入射面 | 0.0002 milli-waves | **极其精确** |
| Surface 4 入射面 | 22 milli-waves | 误差来自表面处理 |
| Surface 5 入射面 | 33 milli-waves | 误差来自表面处理 |

### 关键结论

1. **PROPER 自由空间传播本身不是误差来源**
2. **StateConverter 的写入/读取是完美可逆的**
3. **误差发生在表面处理（几何光线追迹）过程中**

验证脚本：
- `scripts/verify_proper_pilot_beam_consistency.py`
- `scripts/debug_far_field_error_source.py`

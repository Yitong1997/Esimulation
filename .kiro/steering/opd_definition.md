<!------------------------------------------------------------------------------------
# OPD（光程差）定义与统一规范

inclusion: always
------------------------------------------------------------------------------------>

## ⚠️ 核心原则：数据流向

**绝对禁止直接使用 Pilot Beam 对仿真复振幅或光线相位进行赋值！**

正确的数据流向：
- 仿真复振幅 ↔ 光线参数（通过物理仿真）

**Pilot Beam 的唯一用途**：
1. 作为参考相位进行相位解包裹
2. 计算残差 OPD 用于网格重采样
3. 验证仿真结果的正确性

---

## OPD 类型定义

| OPD 类型 | 定义 | 单位 | 使用场景 |
|----------|------|------|----------|
| **绝对光程** | 从物面到当前位置的总光程 Σ(n×d) | mm | optiland 内部 |
| **相对光程差** | 相对于主光线的光程差 | mm/waves | 光线追迹输出 |
| **Pilot Beam OPD** | r²/(2R)，R 带符号，主光线处为 0 | mm | 相位解包裹参考 |
| **残差 OPD** | 实际 OPD + Pilot Beam OPD（注意是加法！） | mm/waves | 网格重采样 |

---

## 各模块的 OPD 约定

### WavefrontToRaysSampler

- **输出**：`rays.opd` = 绝对光程（数值很大，~80mm）
- **⚠️ 不能直接用于混合传播**

### ElementRaytracer

- **处理**：`rays.opd += n × t`（累加光程增量）
- **输出 OPD 含义取决于输入 OPD 的设置**

### HybridElementPropagator

**正确做法**：调用 ElementRaytracer 前，将光线 OPD 设置为 Pilot Beam OPD

---

## 混合传播流程

### 入射面处理

```
┌─────────────────────────────────────────────────────────────────┐
│ 1. 从仿真复振幅采样光线                                          │
│ 2. 计算 Pilot Beam OPD（不使用 sampler 的 OPD！）                │
│ 3. 设置 rays.opd = pilot_opd_mm                                  │
│ 4. 执行光线追迹                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 出射面处理

```
┌─────────────────────────────────────────────────────────────────┐
│ 1. 获取出射光线 OPD（相对于入射面 Pilot Beam 的总 OPD）          │
│ 2. 计算出射面 Pilot Beam OPD（带符号：r²/(2R)，R 可正可负）      │
│ 3. 残差 OPD = output_opd + exit_pilot_opd（注意是加法！）        │
│    说明：absolute_opd > 0，pilot_opd < 0（会聚波），两者相加≈0   │
│ 4. 重采样残差 OPD 到网格                                         │
│ 5. 重建：total_opd = pilot_opd + residual → 仿真复振幅           │
└─────────────────────────────────────────────────────────────────┘
```

---

## OPD 转换公式

- 相位 → OPD：`opd_mm = phase_rad × λ_mm / (2π)`
- OPD → 相位：`phase_rad = 2π × opd_mm / λ_mm`
- OPD → 波长数：`opd_waves = opd_mm / λ_mm`
- Pilot Beam OPD：`opd = r² / (2R)`，R 使用严格公式

---

## 验证检查点

1. **入射面光线 OPD**：应等于 Pilot Beam OPD，范围小（< 1mm），主光线处为 0
2. **出射面残差 OPD**：RMS < 0.01 waves（理想系统）
3. **网格重采样**：残差 OPD 平滑连续，无 2π 跳变

---

## 单位约定

| 量 | 单位 |
|----|------|
| 光线位置 | mm |
| 光线 OPD | mm |
| 波长 | μm |
| Pilot Beam 曲率半径 | mm |
| 相位 | rad |

---

## ⚠️ 已知问题：optiland 相位面 OPD 计算

optiland 的 `PhaseInteractionModel` 存在单位不一致：
- OPD 被放大 1000 倍（μm 当作 mm）
- 符号相反

**WavefrontToRaysSampler 的处理**：
- 光线方向：相位缩小 1000 倍传给 optiland
- 光线 OPD：直接从输入相位插值计算，不依赖 optiland

---

## ⚠️ 已知问题：相位折叠

`np.angle()` 返回 [-π, π] 范围的折叠相位，当输入相位超出此范围时会导致光线方向和 OPD 计算错误。

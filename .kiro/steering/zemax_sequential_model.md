<!------------------------------------------------------------------------------------
# Zemax 序列模式光路定义规范

本文件定义了 Zemax 序列模式的光路结构，以及如何转换到 optiland 全局坐标系。

inclusion: always
------------------------------------------------------------------------------------>

## 概述

本项目采用 **Zemax 序列模式** 的光路定义方式，结合：
- **optiland**：几何光线追迹、OPD 计算（全局坐标系）
- **PROPER**：物理光学波前传播

---

## 坐标系统

### 全局坐标系（optiland 使用）

右手坐标系：Z 轴为初始光轴方向，Y 轴垂直向上，X 轴由右手定则确定。

### 当前坐标系（Zemax 元件定义坐标系）

**Zemax 使用一个随光路演化的"当前坐标系"来定义元件。**

- 初始状态与全局坐标系重合
- 元件参数都相对于当前坐标系定义
- 由表面厚度和坐标断点控制演化

### 光轴坐标系（波前采样用）

用于 PROPER 波前采样，始终以主光线方向为 Z 轴。入射面和出射面始终垂直于光轴。

---

## 当前坐标系的演化规则

### 厚度（Thickness）

每个表面的厚度参数使当前坐标系原点沿其 Z 轴平移。厚度可正可负。


### 坐标断点（Coordinate Break）

**虚拟表面，用于位移和旋转当前坐标系。** 本身不产生光学作用。

| PARM | 参数 | 作用 | 单位 |
|------|------|------|------|
| 1 | Decenter X | 沿当前 X 轴平移 | mm |
| 2 | Decenter Y | 沿当前 Y 轴平移 | mm |
| 3 | Tilt About X | 绕当前 X 轴旋转 | 度 |
| 4 | Tilt About Y | 绕当前 Y 轴旋转 | 度 |
| 5 | Tilt About Z | 绕当前 Z 轴旋转 | 度 |
| 6 | Order | 0=先平移后旋转，1=先旋转后平移 | - |

**旋转顺序**：多轴旋转时按 X → Y → Z 顺序。

**坐标断点的厚度**：完成偏心和旋转后，再沿新 Z 轴平移。

### ⚠️ 反射镜不会自动改变当前坐标系

反射镜只是带有 MIRROR 材料的普通表面。要使当前坐标系跟随反射后的光路方向，必须手动使用坐标断点进行旋转。

---

## Zemax 到 optiland 的坐标转换

**核心思路**：追踪当前坐标系相对于全局坐标系的累积变换，将每个表面的位置和姿态转换到全局坐标系。

---

## 复振幅采样平面

- **入射面**：垂直于入射光轴，原点为主光线与元件表面的交点
- **出射面**：垂直于出射光轴，原点为主光线与元件表面的交点
- **元件切平面**：与元件表面相切，用于计算反射/折射方向

---

## ⚠️ 关键：面形参数在当前坐标系中定义

所有表面形状参数（曲率半径、圆锥常数等）都相对于当前坐标系定义：
- R > 0：曲率中心在当前坐标系 +Z 方向
- R < 0：曲率中心在当前坐标系 -Z 方向
- 转换到全局坐标系：曲率中心 = 顶点 + R × 当前Z轴方向

### 曲率半径符号约定

| 曲率半径 | 曲率中心位置 | 表面类型 |
|----------|--------------|----------|
| R > 0 | +Z 方向（当前坐标系） | 凹面 |
| R < 0 | -Z 方向（当前坐标系） | 凸面 |
| R = ∞ | 无穷远 | 平面 |

### 圆锥常数

| k 值 | 表面类型 |
|------|----------|
| k = 0 | 球面 |
| k = -1 | 抛物面 |
| k < -1 | 双曲面 |
| -1 < k < 0 | 扁椭球面 |
| k > 0 | 长椭球面 |

---

## 单位约定

| 项目 | Zemax 文件 | 内部计算 | optiland | PROPER |
|------|-----------|----------|----------|--------|
| 长度 | mm | mm | mm | m |
| 角度 | 度 | 弧度 | 弧度 | - |

---

## ZMX 文件格式要点

### 表面定义关键字

- `TYPE`：表面类型（STANDARD, COORDBRK, EVENASPH 等）
- `CURV`：曲率 = 1/R
- `DISZ`：厚度
- `GLAS`：材料（MIRROR 表示反射镜）
- `PARM 1-6`：坐标断点参数

### 材料

- `GLAS MIRROR`：反射镜
- `GLAS <name>`：玻璃材料
- 无 GLAS：空气

---
trigger: always_on
---

# 调试优先与变更验证策略

在处理复杂 Bug 或进行大规模代码重构时，必须遵循以下流程：

1.  **调试定位 (Debug First)**
    - 在修改逻辑之前，必须先利用非破坏性的手段（如debug工具）准确地复现并定位问题。
    - 严禁凭猜测直接修改核心逻辑。
    - 必须收集确凿的证据（如变量值、坐标偏差、异常堆栈）证明假设成立。

2.  **计划确认 (Plan Confirmation)**
    - 定位问题后，编写详细的实施计划（Markdown 文档）。
    - 计划必须包含：
        - 问题根因分析 (Root Cause)
        - 拟定的修改方案 (Proposed Changes)
        - 验证方案 (Verification Plan)
    - **关键**：必须使用 `notify_user` 通知用户审核计划。

3.  **用户实施许可 (User Approval)**
    - 只有在用户明确同意（Review approved）实施计划后，方可开始修改代码。
    - 如果用户提出质疑，必须重新回到调试或规划阶段。

4.  **全面变更**
    - 修复应尽可能精准，全局化，要囊括整个完整的项目进行核查，修改完毕后确保所有与其相关的逻辑仍正确运行，未受影响。

此规则适用于所有涉及核心算法（如光线追迹、波前传播、坐标变换）的变更任务。
